{% extends "contacts/base.html" %} 
{% load static %}


{% block leafletheaders %}

    <!-- load main Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin="" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.1.3/dist/esri-leaflet.js" integrity="sha512-pijLQd2FbV/7+Jwa86Mk3ACxnasfIMzJRrIlVQsuPKPCfUBCDMDUoLiBQRg7dAQY6D1rkmCcR8286hVTn/wlIg=="
    crossorigin=""></script>

    <!-- Esri Leaflet Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.9/dist/esri-leaflet-geocoder.css">
    <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.8"></script>
    
{% endblock %}


{% block title %}<title>Main Page</title>{% endblock %}


{% block content %}

    <div class="row">
        <div class="col-md-4">         
            <div class="tabarea">
                <ul class="nav nav-tabs" id="nav-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact">Contact</a>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="home" role="tabpanel">

                        <h3>{{ subject_form.contact }} </h3>

                        {% include 'contacts/workflow_test.html' %}

                        <!--Included template is rendered within the context of its including template 
                            to include additional context, add 'with' to the 'include' statement
                            {# {% include 'test/template.html with person="Joe" greeting="Hey" %} #}
                        -->

                        <form class='my-ajax-form' method='POST' action='.' data-url='#'>
                            {% csrf_token %}
                            {{ form.as_p }}
                            <button type='submit'>Submit</button>
                        </form>

                        {% if user.is_staff %}
                        <a class="btn btn-primary" href="{% url 'subject_create' %}" role="button">+</a>
                        {% endif %}
                    
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel">tab 2 content</div>
                    <div class="tab-pane fade" id="contact" role="tabpanel">Tab 3 content</div>
                </div>
            </div>
        </div>


        <div class="col-md-8">

            <div id="mapid"></div>

            <script>

                var mymap = L.map('mapid', {
                    center: [40.755, -111.88],
                    zoom: 12,
                    minZoom: 10,
                    maxBounds: [
                        [ 40.9, -112.2 ],
                        [ 40.6, -111.7 ]
                    ],
                    maxBoundsViscosity: 0.5,
                });
        
                L.esri.basemapLayer("Topographic").addTo(mymap);
                /*
                L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 20,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoiYXV0aGFsaWMiLCJhIjoiSHppSDJlWSJ9.h8QdzKDNKE1p_XDuzIBoSg',
                }).addTo(mymap);
                */
        
                var searchControl = L.esri.Geocoding.geosearch().addTo(mymap);
        
                var results = L.layerGroup().addTo(mymap);
              
                searchControl.on('results', function(data){
                  results.clearLayers();
                  for (var i = data.results.length - 1; i >= 0; i--) {
                      /*  Change the appearance of the marker here, so it doesn't look like others on map */
                    results.addLayer(L.marker(data.results[i].latlng));
                  }
                });
        
                // go to town with Django template tags and context variables
                {% for subject in subjects %}
        
                    var marker = L.marker([ {{ subject.lat }}, {{ subject.lon }} ], { 
                                   riseOnHover: true,
                                });
        
                    subjectURL = "{% url 'subject-detail' subject.pk %}"
        
                    marker.bindPopup("<h4>{{ subject.contact }}</h4>"
                                    + "<a href='" + subjectURL + "'>Subject: {{ subject.summary }}</a><br><br>"
                                    + "{{ subject.get_comments.count }} comment{{ subject.get_comments.count |pluralize}} on this subject<br><br>"
                                    + "First Reported: {{ subject.initial_date }}<br>" 
                                    + "Last Activity:  {{ subject.last_activity }}"
                                    );
                    marker.bindTooltip("<b> {{ subject.contact }} </b><br> {{ subject.summary }} ")
                    marker.addTo(mymap);
        
                {% endfor %}
        
                // when the marker's popup opens, close any open tooltips
                
            </script>
        </div>
    </div>
    
{% endblock %}
