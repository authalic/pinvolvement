{% extends "contacts/base.html" %} 
{% load static %}


{% block leafletheaders %}

    <!-- load main Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
    crossorigin="" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
    crossorigin=""></script>

    <!-- load jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@2.1.3/dist/esri-leaflet.js" integrity="sha512-pijLQd2FbV/7+Jwa86Mk3ACxnasfIMzJRrIlVQsuPKPCfUBCDMDUoLiBQRg7dAQY6D1rkmCcR8286hVTn/wlIg=="
    crossorigin=""></script>

    <!-- Esri Leaflet Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.9/dist/esri-leaflet-geocoder.css">
    <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.8"></script>
    
{% endblock %}


{% block title %}<title>Main Page</title>{% endblock %}


{% block content %}

    <div id="mapid"></div>
         
        {# <script src='{% static "contacts/js/frontpage_map.js" %}' ></script> #}
        {# template variables don't seem to work when they're imported as part of a js script #}

    <script>

        var mymap = L.map('mapid', {
            center: [40.755, -111.88],
            zoom: 12,
            minZoom: 10,
            maxBounds: [
                [ 40.9, -112.2 ],
                [ 40.6, -111.7 ]
            ],
            maxBoundsViscosity: 0.5,
        });

        L.esri.basemapLayer("Topographic").addTo(mymap);
        /*
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
        maxZoom: 20,
        id: 'mapbox.streets',
        accessToken: 'pk.eyJ1IjoiYXV0aGFsaWMiLCJhIjoiSHppSDJlWSJ9.h8QdzKDNKE1p_XDuzIBoSg',
        }).addTo(mymap);
        */

        var searchControl = L.esri.Geocoding.geosearch().addTo(mymap);

        var results = L.layerGroup().addTo(mymap);
      
        searchControl.on('results', function(data){
          results.clearLayers();
          for (var i = data.results.length - 1; i >= 0; i--) {
              /*  Change the appearance of the marker here, so it doesn't look like others on map */
            results.addLayer(L.marker(data.results[i].latlng));
          }
        });



        // go to town with Django template tags and context variables
        {% for subject in subjects %}

            var marker = L.marker([ {{ subject.lat }}, {{ subject.lon }} ], { 
                           riseOnHover: true,
                        });

            subjectURL = "{% url 'subject-detail' subject.pk %}"

            marker.bindPopup("<h4>{{ subject.contact }}</h4>"
                            + "<a href='" + subjectURL + "'>Subject: {{ subject.summary }}</a><br><br>"
                            + "{{ subject.get_comments.count }} comment{{ subject.get_comments.count |pluralize}} on this subject<br><br>"
                            + "First Reported: {{ subject.initial_date }}<br>" 
                            + "Last Activity:  {{ subject.last_activity }}"
                            );
            marker.bindTooltip("<b> {{ subject.contact }} </b><br> {{ subject.summary }} ")
            marker.addTo(mymap);

        {% endfor %}

        // when the marker's popup opens, close any open tooltips
        
    </script>

    {% if user.is_staff %}
    <a class="btn btn-primary" href="{% url 'subject_create' %}" role="button">Add New Subject</a>
    {% endif %}

    
{% endblock %}
